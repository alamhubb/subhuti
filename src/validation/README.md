# Subhuti Grammar Validation - æ¶æ„è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

Subhutiè¯­æ³•éªŒè¯ç³»ç»Ÿç”¨äº**é™æ€åˆ†æ**Parserçš„è¯­æ³•è§„åˆ™ï¼Œæ£€æµ‹Oråˆ†æ”¯é¡ºåºé—®é¢˜ã€‚

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SubhutiGrammarValidator                   â”‚
â”‚                      ï¼ˆéªŒè¯å™¨å…¥å£ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SubhutiRuleCollector â”‚                 â”‚SubhutiConflictDetectorâ”‚
â”‚   ï¼ˆè§„åˆ™æ”¶é›†å™¨ï¼‰      â”‚                 â”‚   ï¼ˆå†²çªæ£€æµ‹å™¨ï¼‰      â”‚
â”‚                      â”‚                 â”‚                      â”‚
â”‚ åŠŸèƒ½ï¼šæ”¶é›†AST        â”‚                 â”‚ åŠŸèƒ½ï¼šæ£€æµ‹Oråˆ†æ”¯å†²çª  â”‚
â”‚ æ–¹æ³•ï¼šåŒå±‚Proxyæ‹¦æˆª  â”‚                 â”‚ æ–¹æ³•ï¼šå‰ç¼€æ£€æµ‹        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                                           â†“
        â”‚                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚SubhutiGrammarAnalyzer â”‚
        â”‚                                 â”‚  ï¼ˆè¯­æ³•åˆ†æå™¨ï¼‰       â”‚
        â”‚                                 â”‚                      â”‚
        â”‚                                 â”‚ åŠŸèƒ½ï¼šè®¡ç®—è·¯å¾„        â”‚
        â”‚                                 â”‚ æ–¹æ³•ï¼šå±•å¼€subrule     â”‚
        â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                           â†‘
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        æä¾›AST
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. SubhutiRuleCollectorï¼ˆè§„åˆ™æ”¶é›†å™¨ï¼‰

**åŠŸèƒ½**ï¼šæ”¶é›†Parserä¸­æ‰€æœ‰è§„åˆ™çš„ASTç»“æ„

**å®ç°æ–¹æ¡ˆ**ï¼šåŒå±‚Proxyæ‹¦æˆª

- **Parser Proxy**ï¼šæ‹¦æˆªOr/Many/Option/AtLeastOne/å­è§„åˆ™è°ƒç”¨
- **TokenConsumer Proxy**ï¼šæ‹¦æˆªtokenæ¶ˆè´¹è°ƒç”¨

**ä¸ºä»€ä¹ˆéœ€è¦åŒå±‚Proxyï¼Ÿ**
- tokenConsumeræ˜¯ç‹¬ç«‹å¯¹è±¡ï¼Œä¸æ˜¯Parserçš„æ–¹æ³•
- è§„åˆ™å†…éƒ¨é€šè¿‡`this.tokenConsumer.XXX()`æ¶ˆè´¹token
- å•å±‚Proxyæ— æ³•æ‹¦æˆªtokenConsumerçš„æ–¹æ³•è°ƒç”¨

**æ”¶é›†åˆ°çš„ASTèŠ‚ç‚¹ç±»å‹**ï¼š
- `consume`: tokenæ¶ˆè´¹ï¼ˆå¦‚`LParen`, `RParen`ï¼‰
- `subrule`: å­è§„åˆ™è°ƒç”¨ï¼ˆå¦‚`Arguments`, `Identifier`ï¼‰
- `or`: Oråˆ†æ”¯
- `sequence`: åºåˆ—
- `option`: å¯é€‰
- `many`: 0æ¬¡æˆ–å¤šæ¬¡
- `atLeastOne`: è‡³å°‘1æ¬¡

---

### 2. SubhutiGrammarAnalyzerï¼ˆè¯­æ³•åˆ†æå™¨ï¼‰

**åŠŸèƒ½**ï¼šè®¡ç®—è§„åˆ™çš„æ‰€æœ‰å¯èƒ½è·¯å¾„ï¼ˆtokenåºåˆ—ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆA - å®Œå…¨å±•å¼€subrule

**æ ¸å¿ƒåŸç†**ï¼š
1. **å±•å¼€subrule**ï¼šé‡åˆ°subruleèŠ‚ç‚¹æ—¶ï¼Œé€’å½’è®¡ç®—è¯¥è§„åˆ™çš„æ‰€æœ‰å¯èƒ½tokenåºåˆ—
   - ä¸æ˜¯è®°å½•subruleåç§°ï¼ˆå¦‚`'Arguments'`ï¼‰
   - è€Œæ˜¯å±•å¼€ä¸ºå®é™…çš„tokenè·¯å¾„ï¼ˆå¦‚`'LParen,Identifier,RParen,'`ï¼‰

2. **ç¬›å¡å°”ç§¯æ‹¼æ¥**ï¼šå¯¹äºsequenceèŠ‚ç‚¹ï¼Œè®¡ç®—æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„çš„ç¬›å¡å°”ç§¯
   - ç¤ºä¾‹ï¼š`['a,'] Ã— ['b,', 'c,'] = ['a,b,', 'a,c,']`

3. **è·¯å¾„æ ¼å¼**ï¼šä½¿ç”¨é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è¡¨ç¤ºtokenåºåˆ—
   - ç¤ºä¾‹ï¼š`'LParen,RParen,'` è¡¨ç¤º `LParen â†’ RParen`
   - ä¼˜ç‚¹ï¼šå¯ä»¥ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²çš„`startsWith`æ£€æµ‹å‰ç¼€å…³ç³»

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- ç¼“å­˜æœºåˆ¶ï¼šæ¯ä¸ªè§„åˆ™çš„è·¯å¾„åªè®¡ç®—ä¸€æ¬¡
- è·¯å¾„æ•°é‡é™åˆ¶ï¼šé»˜è®¤10000æ¡ï¼ˆé˜²æ­¢è·¯å¾„çˆ†ç‚¸ï¼‰
- è·¯å¾„é•¿åº¦é™åˆ¶ï¼šé»˜è®¤1000ä¸ªtoken
- æ¸è¿›å¼ç»ˆæ­¢ï¼šè¾¾åˆ°é™åˆ¶ç«‹å³åœæ­¢

---

### 3. SubhutiConflictDetectorï¼ˆå†²çªæ£€æµ‹å™¨ï¼‰

**åŠŸèƒ½**ï¼šæ£€æµ‹Orè§„åˆ™ä¸­çš„è·¯å¾„å†²çª

**å®ç°æ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆA - åŸºäºå®Œå…¨å±•å¼€çš„tokenè·¯å¾„è¿›è¡Œå‰ç¼€æ£€æµ‹

**æ£€æµ‹çº§åˆ«**ï¼š

#### Level 1: ç©ºè·¯å¾„æ£€æµ‹ï¼ˆFATALï¼‰
- **æ£€æµ‹**ï¼šåˆ†æ”¯æ˜¯å¦å¯ä»¥åŒ¹é…ç©ºï¼ˆè·¯å¾„åŒ…å«`''`ï¼‰
- **é—®é¢˜**ï¼šå¦‚æœå‰é¢çš„åˆ†æ”¯å¯ä»¥åŒ¹é…ç©ºï¼Œåç»­æ‰€æœ‰åˆ†æ”¯éƒ½ä¸å¯è¾¾
- **ç¤ºä¾‹**ï¼š`Or([Option(A), B])` â†’ `Option(A)`å¯ä»¥åŒ¹é…ç©ºï¼Œ`B`æ°¸è¿œä¸ä¼šè¢«å°è¯•

#### Level 2: å‰ç¼€å†²çªæ£€æµ‹ï¼ˆERRORï¼‰
- **æ£€æµ‹**ï¼šå‰é¢åˆ†æ”¯çš„è·¯å¾„æ˜¯å¦æ˜¯åé¢åˆ†æ”¯è·¯å¾„çš„å‰ç¼€
- **æ–¹æ³•**ï¼šä½¿ç”¨å­—ç¬¦ä¸²çš„`startsWith`æ£€æµ‹
- **ç¤ºä¾‹**ï¼š
  ```
  åˆ†æ”¯Aè·¯å¾„ï¼š'=,'
  åˆ†æ”¯Bè·¯å¾„ï¼š'==,'
  '==,'.startsWith('=,') â†’ trueï¼Œæœ‰å†²çªï¼
  ```
- **åŸå› **ï¼šPEGæ˜¯è´ªå©ªåŒ¹é…ï¼Œåˆ†æ”¯Aä¼šå…ˆåŒ¹é…`'='`ï¼Œå¯¼è‡´åˆ†æ”¯Bçš„`'=='`æ— æ³•å®Œæ•´åŒ¹é…

---

## ğŸ¯ å®Œæ•´æµç¨‹

```
1. SubhutiRuleCollector.collectRules(parser)
   â†“
   æ”¶é›†æ‰€æœ‰è§„åˆ™çš„AST
   {
     'Arguments': { type: 'or', alternatives: [...] },
     'Identifier': { type: 'consume', tokenName: 'Identifier' },
     ...
   }

2. SubhutiGrammarAnalyzer.computePaths('Arguments')
   â†“
   å±•å¼€subruleï¼Œè®¡ç®—æ‰€æœ‰å¯èƒ½çš„tokenè·¯å¾„
   [
     'LParen,RParen,',
     'LParen,Identifier,RParen,',
     'LParen,Identifier,Comma,Identifier,RParen,',
     ...
   ]

3. SubhutiConflictDetector.detectOrConflicts(...)
   â†“
   æ£€æµ‹Oråˆ†æ”¯çš„å‰ç¼€å†²çª
   - è®¡ç®—æ¯ä¸ªåˆ†æ”¯çš„è·¯å¾„
   - ä¸¤ä¸¤æ¯”è¾ƒï¼Œæ£€æµ‹å‰ç¼€å…³ç³»
   - ç”Ÿæˆé”™è¯¯æŠ¥å‘Š

4. SubhutiGrammarValidator.validate()
   â†“
   è¾“å‡ºéªŒè¯ç»“æœ
   - é”™è¯¯åˆ—è¡¨
   - è­¦å‘Šåˆ—è¡¨
   - ç»Ÿè®¡ä¿¡æ¯
```

---

## ğŸ’¡ å…³é”®è®¾è®¡å†³ç­–

### ä¸ºä»€ä¹ˆé€‰æ‹©æ–¹æ¡ˆAï¼ˆå±•å¼€subruleï¼‰ï¼Ÿ

**ä¼˜ç‚¹**ï¼š
- âœ… å‡†ç¡®ï¼šèƒ½æ£€æµ‹åˆ°å®é™…çš„tokenåºåˆ—å†²çª
- âœ… ç›´è§‚ï¼šè·¯å¾„æ˜¯å¯è¯»çš„tokenåºåˆ—
- âœ… å®Œæ•´ï¼šsubruleè¢«å®Œå…¨å±•å¼€

**ç¼ºç‚¹**ï¼š
- âš ï¸ è·¯å¾„çˆ†ç‚¸ï¼šå¤æ‚è§„åˆ™å¯èƒ½äº§ç”Ÿå¤§é‡è·¯å¾„
  - è§£å†³æ–¹æ¡ˆï¼šé™åˆ¶è·¯å¾„æ•°é‡ï¼ˆ10000æ¡ï¼‰
- âš ï¸ é€’å½’è§„åˆ™ï¼šå¯èƒ½å¯¼è‡´æ— é™å±•å¼€
  - è§£å†³æ–¹æ¡ˆï¼šç¼“å­˜æœºåˆ¶
- âš ï¸ æ€§èƒ½å¼€é”€ï¼šéœ€è¦è®¡ç®—å¤§é‡è·¯å¾„
  - è§£å†³æ–¹æ¡ˆï¼šåªåœ¨å¼€å‘ç¯å¢ƒè¿è¡Œ

### ä¸ºä»€ä¹ˆä½¿ç”¨å­—ç¬¦ä¸²çš„startsWithï¼Ÿ

- âœ… ç®€å•é«˜æ•ˆ
- âœ… ç›´è§‚æ˜“æ‡‚
- âœ… ç¬¦åˆPEGçš„è¯­ä¹‰ï¼ˆè´ªå©ªåŒ¹é… + æœ‰åºé€‰æ‹©ï¼‰

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```typescript
import { SubhutiGrammarValidator } from './SubhutiGrammarValidator'
import Es2025Parser from '../language/es2025/Es2025Parser'

// åˆ›å»ºéªŒè¯å™¨
const validator = new SubhutiGrammarValidator()

// éªŒè¯è¯­æ³•
const errors = validator.validate(Es2025Parser)

// è¾“å‡ºç»“æœ
if (errors.length > 0) {
    console.log('å‘ç°è¯­æ³•é—®é¢˜ï¼š')
    errors.forEach(error => {
        console.log(`[${error.level}] ${error.message}`)
        console.log(`  å»ºè®®ï¼š${error.suggestion}`)
    })
}
```

---

## ğŸ”„ ç‰ˆæœ¬å†å²

- **v1.0.0**: åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºæœ¬çš„ASTæ”¶é›†å’Œå‰ç¼€æ£€æµ‹
- **v2.0.0**: æ”¹è¿›ASTæ”¶é›†å™¨ï¼Œä½¿ç”¨åŒå±‚Proxyï¼Œèƒ½å¤Ÿæ­£ç¡®æ”¶é›†consumeå’ŒsubruleèŠ‚ç‚¹
- **v2.1.0**: æ–°å¢Firsté›†åˆè®¡ç®—ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼åˆ‡æ¢

---

## ğŸ”„ **åˆ‡æ¢æ£€æµ‹æ¨¡å¼**

### ä¸¤ç§æ¨¡å¼

#### æ¨¡å¼1ï¼šå®Œå…¨å±•å¼€ï¼ˆé»˜è®¤ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… ç²¾ç¡®æ£€æµ‹
- âœ… èƒ½å‘ç°æ‰€æœ‰å‰ç¼€å†²çª
- âš ï¸ å¯èƒ½è·¯å¾„çˆ†ç‚¸ï¼ˆå¤æ‚è§„åˆ™ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- ç®€å•è§„åˆ™
- éœ€è¦ç²¾ç¡®æ£€æµ‹

#### æ¨¡å¼2ï¼šFirsté›†åˆ

**ç‰¹ç‚¹**ï¼š
- âœ… å¿«é€Ÿï¼Œä¸ä¼šè·¯å¾„çˆ†ç‚¸
- âœ… å†…å­˜å ç”¨å°
- âš ï¸ ä¸å¤Ÿç²¾ç¡®ï¼ˆå¯èƒ½è¯¯æŠ¥æˆ–æ¼æŠ¥ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤æ‚è§„åˆ™
- å¿«é€Ÿæ£€æŸ¥

---

### å¦‚ä½•åˆ‡æ¢

æ‰“å¼€æ–‡ä»¶ï¼š`subhuti/src/validation/SubhutiGrammarAnalyzer.ts`

æ‰¾åˆ°`computePaths`æ–¹æ³•ï¼ˆçº¦ç¬¬106è¡Œï¼‰ï¼Œä¿®æ”¹ç¬¬138-145è¡Œï¼š

```typescript
// 3. é€’å½’è®¡ç®—è·¯å¾„
// ============================================
// ğŸ”„ åˆ‡æ¢ç‚¹ï¼šåœ¨è¿™é‡Œåˆ‡æ¢ä½¿ç”¨å“ªç§æ¨¡å¼
// ============================================

// æ¨¡å¼1ï¼šå®Œå…¨å±•å¼€ï¼ˆç²¾ç¡®ä½†å¯èƒ½è·¯å¾„çˆ†ç‚¸ï¼‰
const paths = this.computeNodePaths(ruleNode)

// æ¨¡å¼2ï¼šFirsté›†åˆï¼ˆå¿«é€Ÿä½†ä¸å¤Ÿç²¾ç¡®ï¼‰
// const firstSet = this.computeNodeFirst(ruleNode)
// const paths = this.convertFirstSetToPaths(firstSet)

// ============================================
```

**åˆ‡æ¢åˆ°Firsté›†åˆæ¨¡å¼**ï¼š

```typescript
// æ¨¡å¼1ï¼šå®Œå…¨å±•å¼€ï¼ˆç²¾ç¡®ä½†å¯èƒ½è·¯å¾„çˆ†ç‚¸ï¼‰
// const paths = this.computeNodePaths(ruleNode)

// æ¨¡å¼2ï¼šFirsté›†åˆï¼ˆå¿«é€Ÿä½†ä¸å¤Ÿç²¾ç¡®ï¼‰
const firstSet = this.computeNodeFirst(ruleNode)
const paths = this.convertFirstSetToPaths(firstSet)
```

å°±è¿™ä¹ˆç®€å•ï¼åªéœ€è¦æ³¨é‡Š/å–æ¶ˆæ³¨é‡Šå¯¹åº”çš„è¡Œå³å¯ã€‚

---

### å¯¹æ¯”ç¤ºä¾‹

#### å®Œå…¨å±•å¼€æ¨¡å¼

```typescript
// Argumentsè§„åˆ™
Arguments: Or([
    LParen + RParen,
    LParen + ArgumentList + RParen
])

// è·¯å¾„ï¼ˆå®Œå…¨å±•å¼€ï¼‰
åˆ†æ”¯#0: ['LParen,RParen,']
åˆ†æ”¯#1: ['LParen,Identifier,RParen,', 'LParen,Ellipsis,Identifier,RParen,', ...]
```

#### Firsté›†åˆæ¨¡å¼

```typescript
// Argumentsè§„åˆ™
Arguments: Or([
    LParen + RParen,
    LParen + ArgumentList + RParen
])

// è·¯å¾„ï¼ˆFirsté›†åˆï¼‰
åˆ†æ”¯#0: ['LParen,']
åˆ†æ”¯#1: ['LParen,']

// æ£€æµ‹ç»“æœï¼šä¸¤ä¸ªåˆ†æ”¯çš„Firstéƒ½æ˜¯'LParen'ï¼Œæœ‰å†²çªï¼ˆè¯¯æŠ¥ï¼‰
```

**æ³¨æ„**ï¼šFirsté›†åˆæ¨¡å¼å¯èƒ½ä¼šè¯¯æŠ¥ï¼Œå› ä¸ºå®ƒåªçœ‹ç¬¬ä¸€ä¸ªtokenï¼Œä¸çœ‹å®Œæ•´è·¯å¾„ã€‚

